rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to validate roadmap status
    function isValidStatus() {
      return request.resource.data.status in ['in-progress', 'completed', 'pending', 'archived'];
    }
    
    // Helper function to validate required roadmap fields
    function hasRequiredRoadmapFields() {
      return request.resource.data.keys().hasAll(['title', 'description', 'track', 'level', 'status', 'createdAt', 'updatedAt']);
    }
    
    // Users collection: Users can read/write their own user document
    match /users/{userId} {
      allow read: if isOwner(userId);
      // Write: Users can only update their own profile with valid fields
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && 
                     (!('uid' in request.resource.data.diff(resource.data).affectedKeys()));
      allow delete: if false; // Prevent user deletion via client (use Cloud Function)
    }
    
    // Tracks collection structure: tracks/{userId}/roadmaps/{roadmapId}
    match /tracks/{userId}/roadmaps/{roadmapId} {
      // Read: Users can only read their own roadmaps
      allow read: if isOwner(userId);
      
      // Create: Users can create their own roadmaps with valid data
      allow create: if isOwner(userId) && 
                     hasRequiredRoadmapFields() && 
                     isValidStatus() &&
                     request.resource.data.isPublic == false;
      
      // Update: Users can update their own roadmaps
      // Note: isPublic changes are handled by Cloud Function
      allow update: if isOwner(userId) && 
                     (!resource.exists || resource.data.keys().hasAll(['title', 'description', 'track', 'level'])) &&
                     isValidStatus();
      
      // Delete: Users can delete their own roadmaps
      allow delete: if isOwner(userId);
      
      // Milestones subcollection: users can only access milestones of their own roadmaps
      match /milestones/{milestoneId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId) &&
                       request.resource.data.keys().hasAll(['id', 'title', 'week', 'description', 'durationHours']);
        allow delete: if isOwner(userId);
      }
      
      // Quiz results subcollection: users can only access quiz results of their own roadmaps
      match /quizResults/{quizResultId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) &&
                        request.resource.data.keys().hasAll(['quizId', 'milestoneId', 'timestamp']);
        allow update: if false; // Quiz results are immutable once created
        allow delete: if isOwner(userId);
      }
    }
    
    // Public roadmaps: Read-only access for authenticated users
    match /publicRoadmaps/{roadmapId} {
      allow read: if isAuthenticated();
      // Only allow writes via Cloud Functions (server-side)
      allow write: if false;
      
      // Milestones subcollection for public roadmaps
      match /milestones/{milestoneId} {
        allow read: if isAuthenticated();
        // Only allow writes via Cloud Functions (server-side)
        allow write: if false;
      }
    }
  }
}